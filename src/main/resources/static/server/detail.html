<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="css/detail.css">
</head>
<body>
	<button type="button" id="detail-close" class="btn-close"><img src="images/close.png"></button>
		<div class="detail">
			<div class="title">
				<input class="input-title" name="title" id="title" placeholder="제목" readonly>
			</div>
			<div class="images">
				<ul id="width-scroll">
				</ul>
			</div>
			<div class="content">
				<textarea id="content" name="content" placeholder="내용을 입력 해주세요." readonly></textarea>
			</div>
			<div class="footer">
				
				<div class="like">
					<input type="checkbox" id="like" name="like" class="check-like">
					<label for="like" id="like-count"></label>

				</div>
				<div class="btsn">

				</div>
				<div id="divLikeLayer" class="overLikeLayer">
					<div class="like-list">
<!--						<strong>내용 :</strong> <span id="conttent">내용</span>-->
						<div class="like-list-title">좋아요 누른 목록</div>
						<div class="like-list-body">
							<ul class="like-member-ul">


							</ul>

						</div>
					</div>
				</div>
			</div>

		</div>
</body>

<script src="js/detail.js"></script>
<script>

	//수정하기 버튼 눌렀을때
	$(document).on('click', '.btn-modify', function () {
		$('.detail.modal').modal("hide");

		$('.modify.modal').modal({
			remote : contextpath+'server/modify.html'
		});
		modify()
	});


	//삭제버튼 눌렀을때
	$(document).on('click', '.btn-delete', function () {
		console.log("삭제")
	});

	$(function(){
		$('.like').mouseover(function(e) { // mouse hover 좌표


			getLike(lnoDesc)


			$('#divLikeLayer').show();
			$('.like-member-ul').html(likeListHtml);



		});
		$('.like').mouseout(function() {
			$('#divLikeLayer').hide();
		});
	});
	var likeLiskHeight = 0;
	$(".like").on('mousewheel',function(e){
		var wheel = e.originalEvent.wheelDelta;
		if(likeLiskHeight>$('.like-member-ul').height()-200){
			likeLiskHeight = $('.like-member-ul').height()-200;
		}
		if(likeLiskHeight<0){
			likeLiskHeight=0;
		}

//스크롤값을 가져온다.
		if(wheel>0){
//스크롤 올릴때
			likeLiskHeight -=30;
			console.log("내림")
			console.log(likeLiskHeight)
			$('.like-list-body').scrollTop(likeLiskHeight)


		} else {
//스크롤 내릴때


			likeLiskHeight +=30;
			console.log("올림")
			console.log(likeLiskHeight)
			$('.like-list-body').scrollTop(likeLiskHeight)
		}
	});

	function modify(){
		var lno = document.getElementById("my-lno").innerHTML;
		var storedFiles = [];
		var areadyStoredFiles = [];
		var deleteStoredFiles = [];

		jQuery(document).ready(function () {
			$.ajax({
				type: "GET",
				url: "/getMyLog/" + lno,
				processData: false,
				contentType: false,
				dataType: 'json',
				success: function (datas) {
					console.log("현재 이미지를 불러옴")
					console.log("---------datas---------")
					console.log(datas)
					$('.modify #title').val(datas.title);
					$('.modify #content').val(datas.content);
					if (datas.imageDTOList.length) {
						$(".modify #width-scroll").css("display", "inline-block");
						$(".modify #content").css("height", "374px");
					} else {
						$(".modify #width-scroll").css("display", "none");
						$(".modify #content").css("height", "580px");
					}
					$('.modify .cvf_uploaded_files').empty()
					datas.imageDTOList.forEach(i => {
						areadyStoredFiles.push(i)
						var html = "<li class='all-image' file = '" + i.imgName + "'>" +
								"<img class = 'img-thumb' src='display?imgUrl=" + i.imageURL + "' />" +
								"<a href = '#' class = 'cvf_delete_image' title = 'Cancel'><img class = 'delete-btn' src='../images/close.png' /></a>" +
								"</li>"
						$('.modify .cvf_uploaded_files').append(html)
					})
				},
				error: function (e) {
					$('#btnUpload').prop('disabled', false);
					alert('fail');
				}
			});
			var data = new FormData();
			$('body').on('change', '.user_picked_files', function () {
				var files = this.files;
				var i = 0;
				for (i = 0; i < files.length; i++) {
					var readImg = new FileReader();
					var file = files[i];
					if (file.type.match('image.*')) {
						storedFiles.push(file);
						readImg.onload = (function (file) {
							return function (e) {
								$('.cvf_uploaded_files').append(
										"<li class='all-image' file = '" + file.name + "'>" +
										"<img class = 'img-thumb' src = '" + e.target.result + "' />" +
										"<a href = '#' class = 'cvf_delete_image' title = 'Cancel'><img class = 'delete-btn' src='../images/close.png' /></a>" +
										"</li>"
								);
							};
						})(file);
						readImg.readAsDataURL(file);
					} else {
						alert('the file ' + file.name + ' is not an image<br/>');
					}
				}
				if (storedFiles.length+areadyStoredFiles.length === 0) {
					$(".modify #width-scroll").css("display", "none");
					$(".modify #content").css("height", "580px");
				} else {
					$(".modify #width-scroll").css("display", "inline-block");
					$(".modify #content").css("height", "374px");
				}
			});
			// 하나씩 제거하기
			$('body').on('click', 'a.cvf_delete_image', function (e) {
				$(this).parent().remove('');
				var file = $(this).parent().attr('file');
				for (var i = 0; i < storedFiles.length; i++) {
					if (storedFiles[i].name == file) {
						storedFiles.splice(i, 1);
						break;
					}
				}
				for (var i = 0; i < areadyStoredFiles.length; i++) {
					if (areadyStoredFiles[i].imgName == file) {
						deleteStoredFiles.push(areadyStoredFiles[i].uuid)
						areadyStoredFiles.splice(i, 1);
						break;
					}
				}
				if (storedFiles.length+areadyStoredFiles.length === 0) {
					$(".modify #width-scroll").css("display", "none");
					$(".modify #content").css("height", "580px");
				} else {
					$(".modify #width-scroll").css("display", "inline-block");
					$(".modify #content").css("height", "374px");
				}
			});
			$('body').on('click', '.modify-btn', function (e) {
				var form = $('#modify')[0];
				// Create an FormData object
				var title = $(".modify input[name='title']").val();
				var content = $(".modify #content").val();
				// var modify = $(".modify #username-check").val();
				// var lat = rightClickLat;
				// var lng = rightClickLng;

				if(title===null||title===""||title===undefined||title==="undefined"){
					alert("제목을 입력해주세요")
					return;
				}
				if(content===null||content===""||content===undefined||content==="undefined"){
					alert("내용을 입력해주세요")
					return;
				}
				data.append("lno", lno);
				for(var i = 0; i <storedFiles.length; i++){
					data.append("files",storedFiles[i]);
				}

				for(var i = 0; i <deleteStoredFiles.length; i++){
					data.append("uuids",deleteStoredFiles[i]);
				}
				data.append("title", title);
				data.append("content", content);
				//폼데이터 출력해보기
				console.log("---------------------")
				for (var key of data.keys()) {
					console.log(key);
				}
				console.log("---------------------")
				for (var value of data.values()) {
					console.log(value);
				}
				console.log("---------------------")
				for(var pair of data.entries()){
					console.log(pair[0]+","+ pair[1])
				}
				// $.ajax({
				//     type: "POST",
				//     url: "/editMapLog",
				//     data: data,
				//     processData: false,
				//     contentType: false,
				//     dataType: 'json',
				//     success: function (data) {
				// 		alert('success');
				//     },
				//     error: function (e) {
				//
				//         alert('fail');
				//     }
				//
				// });

			});

		});

		$(".modify #width-scroll").on('mousewheel', function (e) {
			var wheelDelta = e.originalEvent.wheelDelta;
			if (wheelDelta > 0) {
				$(this).scrollLeft(-wheelDelta + $(this).scrollLeft());
			} else {
				$(this).scrollLeft(-wheelDelta + $(this).scrollLeft());
			}
		});

		$("body").on("click", ".btn-cancle", function(){
			$('.modify.modal').modal("hide");
			$('.detail.modal').modal("hide");
		})
	}
</script>
</html>